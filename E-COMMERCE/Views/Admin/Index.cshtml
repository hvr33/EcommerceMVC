@model E_COMMERCE.ViewModels.AdminDashboardViewModel
@{
    ViewData["Title"] = "لوحة التحكم";
    ViewData["ActiveMenu"] = "dashboard";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}
@functions {
    public string GetActivityColor(string activityType) => activityType switch
        {
            "Error" => "text-danger",
            "Warning" => "text-warning",
            "Info" => "text-info",
            _ => "text-secondary"
        };

        public string GetActivityBgColor(string activityType) => activityType switch
        {
            "Error" => "bg-danger",
            "Warning" => "bg-warning",
            "Info" => "bg-info",
            _ => "bg-secondary"
        };


#line default
#line hidden
#nullable disable

#nullable restore
#line (44, 2) - (56, 1) "D:\desktop\project.c#\E-COMMERCE\E-COMMERCE\Views\Admin\Index.cshtml"


        public string GetActivityIcon(string activityType) => activityType switch
        {
            "Error" => "bi-exclamation-triangle",
            "Warning" => "bi-exclamation-circle",
            "Info" => "bi-info-circle",
            _ => "bi-info-square"
        };

#line default
#line hidden
#nullable disable

#nullable restore
#line (29, 17) - (44, 1) "D:\desktop\project.c#\E-COMMERCE\E-COMMERCE\Views\Admin\Index.cshtml"

        public string GetRelativeTime(DateTime? dateTime)
    {
        if (dateTime == null) return "غير متوفر";

        var now = DateTime.Now;
        var diff = now - dateTime.Value;

        if (diff.TotalMinutes < 1) return "الآن";
        if (diff.TotalMinutes < 60) return $"منذ {Math.Floor(diff.TotalMinutes)} دقيقة";
        if (diff.TotalHours < 24) return $"منذ {Math.Floor(diff.TotalHours)} ساعة";
        if (diff.TotalDays < 7) return $"منذ {Math.Floor(diff.TotalDays)} يوم";
        
        return dateTime.Value.ToString("dd/MM/yyyy HH:mm");
    }
}

   
@* تحديث ViewBag بالبيانات الديناميكية *@
@{
    ViewBag.StoreName = "متجري الإلكتروني";
    ViewBag.NewOrdersCount = Model?.PendingOrders ?? 0;
}

<div class="row g-4 mb-5">
    <!-- إحصائيات سريعة -->
    <div class="col-xl-3 col-md-6">
        <div class="card stats-card bg-primary text-white h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="card-title mb-1">إجمالي المنتجات</h5>
                        <h2 class="mb-0">@Model?.TotalProducts.ToString("N0")</h2>

                    </div>
                    <div class="text-end">
                        <i class="bi bi-box-seam fs-1 opacity-75"></i>
                    </div>
                </div>
                <div class="mt-3">
                    <small class="text-white-50">
                        <i class="bi bi-arrow-up-circle me-1"></i>
                        <span class="fw-bold">+@(Model?.ProductGrowthRate ?? 0):2f%</span> من الشهر الماضي
                    </small>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6">
        <div class="card stats-card bg-success text-white h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="card-title mb-1">الطلبات الجديدة</h5>
                        <h2 class="mb-0">@Model?.NewOrdersToday.ToString("N0")</h2>

                    </div>
                    <div class="text-end">
                        <i class="bi bi-cart-check fs-1 opacity-75"></i>
                    </div>
                </div>
                <div class="mt-3">
                    <small class="text-white-50">
                        <i class="bi bi-arrow-up-circle me-1"></i>
                        <span class="fw-bold">+25%</span> اليوم
                    </small>
                </div>
            </div>
        </div>
    </div>

    @* <div class="col-xl-3 col-md-6">
        <div class="card stats-card bg-info text-white h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="card-title mb-1">المستخدمين</h5>
                        <h2 class="mb-0">@Model != null ? Model.TotalUsers.ToString("N0") : "0"</h2>

                    </div>
                    <div class="text-end">
                        <i class="bi bi-people fs-1 opacity-75"></i>
                    </div>
                </div>
                <div class="mt-3">
                    <small class="text-white-50">
                        <i class="bi bi-arrow-up-circle me-1"></i>
                        <span class="fw-bold">+@(Model?.UserGrowthRate ?? 0):2f%</span> من الشهر الماضي
                    </small>
                </div>
            </div>
        </div>
    </div> *@

    <div class="col-xl-3 col-md-6">
        <div class="card stats-card bg-warning text-white h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="card-title mb-1">الإيرادات الشهرية</h5>
                        <h2 class="mb-0">@Model?.RevenueThisMonth.ToString("N0") <small class="fs-5">ر.س</small></h2>
                    </div>
                    <div class="text-end">
                        <i class="bi bi-currency-dollar fs-1 opacity-75"></i>
                    </div>
                </div>
                <div class="mt-3">
                    <small class="text-white-50">
                        <i class="bi bi-arrow-up-circle me-1"></i>
                        <span class="fw-bold">+15%</span> مقارنة بالشهر الماضي
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- الرسوم البيانية -->
<div class="row g-4 mb-5">
    <div class="col-lg-8">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-graph-up me-2"></i>
                    إحصائيات المبيعات الشهرية
                </h5>
                <div>
                    <button class="btn btn-sm btn-outline-secondary me-2" onclick="loadSalesStats('week')">
                        الأسبوع
                    </button>
                    <button class="btn btn-sm btn-outline-secondary me-2" onclick="loadSalesStats('month')">
                        الشهر
                    </button>
                    <button class="btn btn-sm btn-primary" onclick="loadSalesStats('year')">
                        السنة
                    </button>
                </div>
            </div>
            <div class="card-body">
                <canvas id="salesChart" height="100"></canvas>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-pie-chart me-2"></i>
                    حالة الطلبات
                </h5>
            </div>
            <div class="card-body">
                <canvas id="ordersChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- المنتجات الأكثر مبيعاً والطلبات الأخيرة -->
<div class="row g-4 mb-5">
    <!-- المنتجات الأكثر مبيعاً -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-trophy me-2"></i>
                    المنتجات الأكثر مبيعاً
                </h5>
                <a href="@Url.Action("Index", "Products")" class="btn btn-sm btn-primary">
                    عرض الكل <i class="bi bi-arrow-left ms-1"></i>
                </a>
            </div>
            <div class="card-body">
                @if (Model?.TopSellingProducts != null && Model.TopSellingProducts.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th width="50%">المنتج</th>
                                    <th width="15%">السعر</th>
                                    <th width="15%">المبيعات</th>
                                    <th width="20%">الإيرادات</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var product in Model.TopSellingProducts.Take(5))
                                {
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <img src="@(product.ProductImage ?? "https://via.placeholder.com/40x40/0d6efd/ffffff?text=P")"
                                                     class="rounded me-2" alt="@product.ProductName" style="width: 40px; height: 40px; object-fit: cover;">
                                                <div>
                                                    <div class="fw-bold">@product.ProductName</div>
                                                    <small class="text-muted">@(product.CategoryName ?? "غير محدد")</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge bg-success">@product.AveragePrice.ToString("N0") ر.س</span>
                                        </td>
                                        <td>
                                            <span class="text-success fw-bold">@product.TotalSales.ToString("N0")</span>
                                            <small class="text-muted d-block">وحدة</small>
                                        </td>
                                        <td>
                                            <span class="text-primary fw-bold">@product.TotalRevenue.ToString("N0") ر.س</span>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="text-center py-5">
                        <i class="bi bi-inbox display-1 text-muted"></i>
                        <p class="text-muted mt-3">لا توجد بيانات للمنتجات المباعة</p>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- الطلبات الأخيرة -->
    <div class="col-lg-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-clock-history me-2"></i>
                    الطلبات الأخيرة
                </h5>
                @* <a href="@Url.Action("Order1", "Orders")" class="btn btn-sm btn-primary">
                    عرض الكل <i class="bi bi-arrow-left ms-1"></i>
                </a> *@
            </div>
            <div class="card-body">
                @if (Model?.RecentOrders != null && Model.RecentOrders.Any())
                {
                    <div class="list-group list-group-flush">
                        @foreach (var order in Model.RecentOrders.Take(5))
                        {
                            <a href="@Url.Action("Details", "Orders", new { id = order.OrderId })"
                               class="list-group-item list-group-item-action d-flex justify-content-between align-items-center px-0 py-3">
                                <div>
                                    <div class="fw-bold text-truncate" style="max-width: 150px;">#@order.OrderNumber</div>
                                    <small class="text-muted d-block text-truncate" style="max-width: 150px;">@order.UserName</small>
                                    <small class="text-muted">
                                        <i class="bi bi-calendar3 me-1"></i>
                                        @order.OrderDate.ToString("dd/MM/yyyy HH:mm")
                                    </small>
                                </div>
                                <div class="text-end">
                                    <div class="fw-bold text-primary">@order.TotalAmount.ToString("N0") ر.س</div>
                                    <span class="badge @(order.StatusColor == "success" ? "bg-success" : "bg-warning") rounded-pill">
                                        @order.StatusText
                                    </span>
                                </div>
                            </a>
                        }
                    </div>
                }
                else
                {
                    <div class="text-center py-5">
                        <i class="bi bi-cart-x display-1 text-muted"></i>
                        <p class="text-muted mt-3">لا توجد طلبات حالياً</p>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- الأنشطة الأخيرة -->
<div class="row g-4 mb-5">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-activity me-2"></i>
                    الأنشطة الأخيرة
                </h5>
                <button class="btn btn-sm btn-outline-secondary" onclick="loadRecentActivities()">
                    <i class="bi bi-arrow-clockwise me-1"></i>تحديث
                </button>
            </div>
            <div class="card-body">
                @if (Model?.RecentActivities != null && Model.RecentActivities.Any())
                {
                    <div class="timeline">
                        @foreach (var activity in Model.RecentActivities.Take(10))
                        {
                            <div class="timeline-item">
                                <div class="timeline-time">
                                    <i class="bi bi-clock @(GetActivityColor(activity.ActivityType)) me-2"></i>
                                    <span>@GetRelativeTime(activity.CreatedAt)</span>
                                </div>
                                <div class="timeline-content">
                                    <div class="d-flex align-items-start">
                                        <div class="flex-shrink-0">
                                            <div class="avatar @(GetActivityBgColor(activity.ActivityType)) text-white rounded-circle d-flex align-items-center justify-content-center"
                                                 style="width: 40px; height: 40px; font-size: 0.875rem;">
                                                <i class="@GetActivityIcon(activity.ActivityType)"></i>
                                            </div>
                                        </div>
                                        <div class="flex-grow-1 ms-3">
                                            <h6 class="mb-1">@activity.UserName</h6>
                                            <p class="mb-1">@activity.Description</p>
                                            <small class="text-muted">
                                                <i class="bi bi-geo-alt me-1"></i>
                                                @activity.IpAddress
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="text-center py-5">
                        <i class="bi bi-activity display-1 text-muted"></i>
                        <p class="text-muted mt-3">لا توجد أنشطة حالياً</p>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- CSS مخصص للصفحة -->
<style>
    .timeline {
        position: relative;
        padding-right: 2rem;
    }

        .timeline::before {
            content: '';
            position: absolute;
            right: 0.5rem;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(to bottom, #0d6efd, #198754);
        }

    .timeline-item {
        position: relative;
        margin-bottom: 1.5rem;
    }

        .timeline-item::before {
            content: '';
            position: absolute;
            right: -0.75rem;
            top: 0.25rem;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #0d6efd;
            z-index: 1;
        }

    .timeline-time {
        font-size: 0.875rem;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: #6c757d;
    }

    .timeline-content {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 0.5rem;
        border-left: 3px solid #0d6efd;
        margin-right: 1rem;
    }

    .avatar {
        width: 40px;
        height: 40px;
        font-size: 0.875rem;
    }

    .table th {
        border-top: none;
        font-weight: 600;
        color: #495057;
    }

    .list-group-item-action {
        transition: all 0.2s ease;
        border-radius: 0.375rem;
        margin-bottom: 0.25rem;
    }

        .list-group-item-action:hover {
            background-color: #f8f9ff;
            border-color: #0d6efd;
            transform: translateX(-5px);
        }

    .badge {
        font-size: 0.75rem;
        min-width: 70px;
        text-align: center;
    }

    .stats-card h2 {
        font-size: 2rem;
        font-weight: 700;
    }

    .card-header {
        background-color: rgba(0, 0, 0, 0.03);
        border-bottom: 1px solid rgba(0, 0, 0, 0.125);
    }
</style>

<!-- JavaScript للصفحة -->
<script>
    let salesChart, ordersChart;

    // تهيئة الرسوم البيانية
    document.addEventListener('DOMContentLoaded', function() {
        initializeCharts();
        loadSalesStats('month');
        loadRecentActivities();

        // تأثيرات التحميل
        const cards = document.querySelectorAll('.card');
        cards.forEach((card, index) => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';
            setTimeout(() => {
                card.style.transition = 'all 0.6s ease';
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, index * 100);
        });

        // تأثير hover على الجدول
        document.querySelectorAll('tbody tr').forEach(row => {
            row.addEventListener('mouseenter', function() {
                this.style.backgroundColor = '#f8f9ff';
            });
            row.addEventListener('mouseleave', function() {
                this.style.backgroundColor = '';
            });
        });
    });

    function initializeCharts() {
        // رسم بياني للمبيعات
        const salesCtx = document.getElementById('salesChart').getContext('2d');
        salesChart = new Chart(salesCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'الإيرادات (ر.س)',
                    data: [],
                    borderColor: '#0d6efd',
                    backgroundColor: 'rgba(13, 110, 253, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString() + ' ر.س';
                            }
                        }
                    }
                }
            }
        });

        // رسم بياني دائري لحالة الطلبات
        const ordersCtx = document.getElementById('ordersChart').getContext('2d');
        ordersChart = new Chart(ordersCtx, {
            type: 'doughnut',
            data: {
                labels: ['مكتمل', 'معلق'],
                datasets: [{
                    data: [@Model?.CompletedOrders, @Model?.PendingOrders],
                    backgroundColor: ['#198754', '#ffc107'],
                    borderWidth: 0,
                    hoverOffset: 10
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true
                        }
                    }
                }
            }
        });
    }

    function loadSalesStats(period) {
        // إضافة حالة التحميل
        const buttons = document.querySelectorAll('[onclick="loadSalesStats()"]');
        buttons.forEach(btn => {
            btn.innerHTML = '<span class="loading me-1"></span>جاري التحميل...';
            btn.disabled = true;
        });

        fetch(`/Admin/SalesStats?period=${period}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.data) {
                    updateSalesChart(data.data);
                }
            })
            .catch(error => {
                console.error('Error loading sales stats:', error);
                showToast('فشل في تحميل إحصائيات المبيعات', 'error');
            })
            .finally(() => {
                buttons.forEach(btn => {
                    btn.innerHTML = btn.textContent.replace('جاري التحميل...', '');
                    btn.disabled = false;
                });
            });
    }

    function updateSalesChart(data) {
        salesChart.data.labels = data.map(item => new Date(item.date).toLocaleDateString('ar-SA'));
        salesChart.data.datasets[0].data = data.map(item => item.totalRevenue);
        salesChart.update('none');
    }

    function loadRecentActivities() {
        fetch('/Admin/RecentActivities')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // تحديث قائمة الأنشطة
                    updateActivitiesList(data.activities);
                }
            })
            .catch(error => {
                console.error('Error loading activities:', error);
            });
    }

    function updateActivitiesList(activities) {
        const timeline = document.querySelector('.timeline');
        if (timeline && activities.length > 0) {
            timeline.innerHTML = activities.map(activity => `
                <div class="timeline-item">
                    <div class="timeline-time">
                        <i class="bi bi-clock text-primary me-2"></i>
                        <span>${getRelativeTime(new Date(activity.createdAt))}</span>
                    </div>
                    <div class="timeline-content">
                        <div class="d-flex align-items-start">
                            <div class="flex-shrink-0">
                                <div class="avatar bg-primary text-white rounded-circle d-flex align-items-center justify-content-center"
                                     style="width: 40px; height: 40px;">
                                    <i class="bi bi-person"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="mb-1">${activity.userName}</h6>
                                <p class="mb-1">${activity.description}</p>
                                <small class="text-muted">
                                    <i class="bi bi-geo-alt me-1"></i>
                                    ${activity.ipAddress}
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
    }

    function getRelativeTime(date) {
        const now = new Date();
        const diff = now - new Date(date);
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);

        if (minutes < 1) return 'الآن';
        if (minutes < 60) return `منذ ${minutes} دقيقة`;
        if (hours < 24) return `منذ ${hours} ساعة`;
        if (days < 7) return `منذ ${days} يوم`;
        return new Date(date).toLocaleDateString('ar-SA');
    }

    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `alert alert-${type === 'error' ? 'danger' : 'success'} alert-dismissible fade show position-fixed`;
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        toast.innerHTML = `
            <i class="bi bi-${type === 'error' ? 'exclamation-triangle' : 'check-circle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(toast);

        setTimeout(() => {
            const bsAlert = new bootstrap.Alert(toast);
            bsAlert.close();
        }, 5000);
    }

    // تحديث الإحصائيات كل 5 دقائق
    setInterval(() => {
        loadSalesStats('month');
        loadRecentActivities();
    }, 300000);

    // تشغيل التحديث التلقائي للأنشطة كل دقيقة
    setInterval(() => {
        const timeElements = document.querySelectorAll('.timeline-time span');
        timeElements.forEach(timeEl => {
            // تحديث الأوقات النسبية
            const activityTime = timeEl.dataset.timestamp ? new Date(parseInt(timeEl.dataset.timestamp)) : new Date();
            timeEl.textContent = getRelativeTime(activityTime);
        });
    }, 60000);
</script>