@* PSEUDOCODE / PLAN:
   - Ensure safe null/empty check for Model before enumerating.
   - Render a cart dropdown showing either "Your cart is empty" or a list of cart items.
   - Use Url.Content for image paths to avoid hard-coded ports.
   - Render the full cart table below the dropdown with update and remove forms.
   - Provide client-side handler to remove an item from the dropdown via fetch POST and remove DOM node on success.
   - Compute and display total safely using Model?.Sum(...) to avoid null reference.
*@

@model List<Cart>


<li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle" href="#" id="cartDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
        My Cart
    </a>

    <ul class="dropdown-menu dropdown-menu-end p-3" style="min-width:300px; max-height:400px; overflow-y:auto;">
        @if (Model == null || !Model.Any())
        {
            <li class="text-center text-muted">Your cart is empty</li>
        }
        else
        {
            @foreach (var item in Model)
            {
                <li class="d-flex mb-2 align-items-center border-bottom pb-2" id="cart-item-@item.Id">
                    <img src="@Url.Content($"~/upload/{item.Photo}")" alt="@item.Product?.Description"
                         style="width:50px; height:50px; object-fit:cover; border-radius:5px; margin-right:10px;">
                    <div class="flex-grow-1">
                        <div class="fw-bold">@item.Product?.Description</div>
                        <div class="text-success">$@item.Price</div>
                        <div>Qty: @item.Quntity</div>
                    </div>
                    <button class="btn btn-sm btn-danger remove-cart-item" data-id="@item.Id" type="button">&times;</button>
                </li>
            }
            <li class="mt-2">
                <a href="/Home/cart" class="btn btn-primary w-100">Go to Cart</a>
            </li>
        }
    </ul>
</li>
@if (TempData["CartError"] != null)
{
    <div class="alert alert-warning text-center">
        @TempData["CartError"]
    </div>
}

<script>
    // Remove cart item dynamically from dropdown
    document.querySelectorAll(".remove-cart-item").forEach(btn => {
        btn.addEventListener("click", function () {
            var itemId = this.getAttribute("data-id");

            fetch(`/Home/RemoveFromCart/${itemId}`, { method: 'POST' })
            .then(res => {
                if (res.ok) {
                    var el = document.getElementById(`cart-item-${itemId}`);
                    if (el) el.remove();
                }
            });
        });
    });
</script>

@{
    ViewData["Title"] = "Shopping Cart";
}

<div class="container my-5">
    <h2 class="text-center mb-4">Shopping Cart</h2>

    <div class="table-responsive">
        <table class="table table-hover align-middle text-center">
            <thead class="table-dark">
                <tr>
                    <th scope="col">Product</th>
                    <th scope="col">Price</th>
                    <th scope="col">Quantity</th>
                    <th scope="col">Total</th>
                    <th scope="col">Image</th>
                    <th scope="col">Action</th>
                </tr>
            </thead>
            <tbody>
                @if (Model != null)
                {
                    @foreach (var item in Model)
                    {
                        <tr>
                            <td>@item.Product?.Name</td>
                            <td>$@($"{item.Product?.Price:0.00}")</td>
                            <td>
                                <form asp-action="UpdateCartItemQuantity" asp-controller="Home" method="post" class="d-flex justify-content-center">
                                    <input type="number" name="quantity" value="@item.Quntity" min="1" class="form-control form-control-sm w-50 me-2" />
                                    <input type="hidden" name="productId" value="@item.Productid" />
                                    <button type="submit" class="btn btn-sm btn-primary">Update</button>
                                </form>
                            </td>
                            <td>$@( (item.Product?.Price ?? 0) * item.Quntity )</td>
                            <td>
                                <img src="@Url.Content($"~/upload/{item.Product?.Photo}")" alt="@item.Product?.Name" class="img-thumbnail" style="width:100px; height:100px; object-fit:cover;" />
                            </td>
                            <td>
                                <form asp-action="removefromCart" asp-controller="Home" asp-route-id="@item.Productid" method="post">
                                    <button type="submit" class="btn btn-danger btn-sm"><i class="bi bi-trash-fill"></i> Remove</button>
                                </form>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>

    <div class="d-flex justify-content-end my-3">
        <h4>Total: $@((Model?.Sum(x => (x.Product?.Price ?? 0) * x.Quntity)) ?? 0)</h4>
    </div>

    <div class="text-end">
        <a href="/Home/completecarts" class="btn btn-success btn-lg">Proceed to Checkout</a>
    </div>
</div>

<style>
    table.table-hover tbody tr:hover {
        background-color: #f1f1f1;
        transition: 0.3s;
    }
    .img-thumbnail {
        border-radius: 8px;
    }
    h2 {
        color: #333;
    }
    .btn-lg {
        min-width: 180px;
    }
</style>
